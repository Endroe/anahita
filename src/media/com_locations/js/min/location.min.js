/*! anahita 01-02-2016 */
!function(a,b,c){"use strict";a.widget("anahita.locations",{options:{modal:"#an-modal",formSelector:'a[data-trigger="FormSelector"]',formContainer:"#location-form-container",loationsSelector:'a[data-trigger*="LocationSelector"]',locationsContainer:"#locations-container",searchQuery:"#an-search-query",entities:".an-entities",entity:".an-entity",locationsList:".an-locations"},_create:function(){var b=this;this.modal=a(this.options.modal),this.formContainer=null,this.locationsContainer=null,this.currentList=null,this.locatableId=null,this._on(this.options.loationsSelector,{click:function(c){c.preventDefault(),b.locatableId=a(c.currentTarget).data("locatable"),b._showSelector(c.currentTarget)}}),this._on(a(c),{afterFilterbox:function(a){var c=b.locationsContainer.find(this.options.entity);0==c.length?b._showForm():b._init()}})},_init:function(){var a=this;this._on('a[data-action="add-location"]',{click:function(b){b.preventDefault(),a._addLocation(b.currentTarget)}}),this._on('a[data-action="delete-location"]',{click:function(b){b.preventDefault(),a._deleteLocation(b.currentTarget)}})},_showSelector:function(b){var c=this;this.modal.find(".modal-footer").hide();var d=this.modal.find(".modal-header").find("h3"),e=this.modal.find(".modal-body");a.get(a(b).attr("href"),function(b){d.html(a(b).filter(".modal-header").html()),e.html(a(b).filter(".modal-body").html()),c.modal.modal("show"),c.formContainer=a(c.options.formContainer),c.locationsContainer=a(c.options.locationsContainer),c.searchQuery=a(c.options.searchQuery),c.formContainer.hide(),c._browse()})},_browse:function(){var b=this,c=b.locationsContainer.find(this.options.entities),d=null,e=null;if(a("body").data("browser_coords"))var f=a("body").data("browser_coords"),d=f.latitude,e=f.longitude;a.ajax({method:"GET",url:c.data("url"),data:{nearby_latitude:d,nearby_longitude:e},success:function(d){var e=a(d).filter(b.options.entity);e.length?(b._hideForm(),a(c).html(e),b._init()):b._showForm()}})},_add:function(){var b=this,c=b.formContainer.find("form");a.ajax({method:"POST",url:c.attr("action"),data:c.serialize(),beforeSend:function(){c.find(":submit").button("loading")},success:function(a){b._refresh(),b.modal.modal("hide")},complete:function(a,b){c.find(":submit").button("reset")}})},_showForm:function(){var b=this;this.formContainer.show(),this.locationsContainer.hide();var c=this.formContainer.find("form");this._on(c,{submit:function(a){a.preventDefault(),b._add()}}),this._on(this.options.formSelector,{click:function(a){a.preventDefault(),b._hideForm()}}),this.searchQuery.val()&&a(c).find('input[name="name"]').val(this.searchQuery.val())},_hideForm:function(){this.formContainer.hide(),this.locationsContainer.show()},_addLocation:function(b){var c=this,d=a(b);a.ajax({method:"POST",url:d.data("url"),data:{action:"addlocation",location_id:d.data("location")},success:function(a){c.modal.modal("hide"),c._refresh()}})},_deleteLocation:function(b){var c=a(b);a.ajax({method:"POST",url:c.data("url"),data:{action:"deletelocation",location_id:c.data("location")},success:function(a){c.closest("li").fadeOut()}})},_refresh:function(){var b=this,c=a("#locations-"+this.locatableId);a.ajax({method:"GET",url:c.data("url"),success:function(a){c.html(a),b._init()}})}});var d=null;a(c).ready(function(b){a(".an-locations").each(function(b,c){a.ajax({url:a(c).data("url"),success:function(b){a(c).html(b),d||(d=a("body").locations())}})})})}(jQuery,window,document);