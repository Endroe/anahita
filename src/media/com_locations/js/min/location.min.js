/*! anahita 12-02-2016 */
!function(a,b,c){"use strict";if(a.widget("anahita.locations",{options:{modal:"#an-modal",formSelector:'a[data-trigger="FormSelector"]',formContainer:"#location-form-container",loationsSelector:'[data-trigger*="LocationSelector"]',locationsContainer:"#locations-container",searchQuery:"#an-search-query",entities:".an-entities",entity:".an-entity",locationsList:".an-locations"},_create:function(){var b=this;this.modal=a(this.options.modal),this.formContainer=null,this.locationsContainer=null,this.currentList=null,this.locatableId=null,this.browser_coords=null,this._on(a(c),{geoposition:function(c){a(b.options.loationsSelector).prop("disabled",!1)}}),this._on(this.options.loationsSelector,{click:function(c){c.preventDefault(),b.locatableId=a(c.currentTarget).data("locatable"),b._showSelector(c.currentTarget)}}),a(this.options.locationsList).each(function(b,c){a(c).load(a(c).data("url"))}),this._on(this.element,{afterFilterbox:function(a){var c=b.locationsContainer.find(this.options.entity);0==c.length&&b._showForm()},beforeFilterbox:function(c){var d=b.locationsContainer.find(b.options.entities),e=a(b.options.locationsContainer).find("form");console.log(a(b.options.searchQuery).val()),""==a(b.options.searchQuery).val()?e.attr("action",d.data("url")+"&"+b.browser_coords):e.attr("action",d.data("url"))}})},_showSelector:function(b){var c=this;this.modal.find(".modal-footer").hide();var d=this.modal.find(".modal-header").find("h3"),e=this.modal.find(".modal-body");a.get(a(b).data("url"),function(b){d.html(a(b).filter(".modal-header").html()),e.html(a(b).filter(".modal-body").html()),c.modal.modal("show"),c.formContainer=a(c.options.formContainer),c.locationsContainer=a(c.options.locationsContainer),c.searchQuery=a(c.options.searchQuery),c.formContainer.hide(),c._browse()})},_browse:function(){var b=this,d=this.locationsContainer.find(this.options.entities),e=d.data("url");if(a(c).data("browser_coords")){var f=a(c).data("browser_coords");this.browser_coords=a.param({nearby_latitude:f.latitude,nearby_longitude:f.longitude})}a.ajax({method:"GET",url:e+"&"+b.browser_coords,success:function(c){var e=a(c).filter(b.options.entity);e.length?(b._hideForm(),a(d).html(e)):b._showForm()}})},_add:function(){var b=this,c=b.formContainer.find("form");a.ajax({method:"POST",url:c.attr("action"),data:c.serialize(),beforeSend:function(){c.find(":submit").button("loading")},success:function(a){b._refresh(),b.modal.modal("hide")},complete:function(a,b){c.find(":submit").button("reset")}})},_showForm:function(){var b=this;this.formContainer.show(),this.locationsContainer.hide();var c=this.formContainer.find("form");this._on(c,{submit:function(a){a.preventDefault(),b._add()}}),this._on(this.options.formSelector,{click:function(a){a.preventDefault(),b._hideForm()}}),this.searchQuery.val()&&a(c).find('input[name="name"]').val(this.searchQuery.val())},_hideForm:function(){this.formContainer.hide(),this.locationsContainer.show()},addLocation:function(b){var c=this,d=a(b);a.ajax({method:"POST",url:d.data("url"),data:{action:"addlocation",location_id:d.data("location")},success:function(a){c.modal.modal("hide"),c._refresh()}})},deleteLocation:function(b){var c=a(b);a.ajax({method:"POST",url:c.data("url"),data:{action:"deletelocation",location_id:c.data("location")},success:function(a){c.closest("li").fadeOut()}})},_refresh:function(){var b=a("#locations-"+this.locatableId);a.ajax({method:"GET",url:b.data("url"),success:function(a){b.html(a)}})}}),a(".an-locations").length){var d=a("body").locations();a("body").on("click",'a[data-action="add-location"]',function(a){a.preventDefault(),d.locations("addLocation",this)}),a("body").on("click",'a[data-action="delete-location"]',function(a){a.preventDefault(),d.locations("deleteLocation",this)})}}(jQuery,window,document);