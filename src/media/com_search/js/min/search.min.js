/*! anahita 07-02-2016 */
!function(a,b,c){"use strict";a.widget("anahita.search",{options:{searchForm:'form[data-trigger="SearchRequest"]',query:"input[name=q]",sortOption:'select[data-trigger="SortOption"]',commentOption:'input[data-trigger="SearchOption"]',nearbyOption:'input[data-trigger="SearchNearby"]',rangeOption:'select[data-trigger="SearchRange"]',scope:'[data-trigger="ChangeScope"]',results:"#an-search-results",searchScopes:".search-scopes"},_create:function(){this.form=a(this.options.searchForm);var b=this.form.find(this.options.query),c=a(this.options.sortOption),d=a(this.options.commentOption),e=a(this.options.nearbyOption),f=a(this.options.rangeOption),g=a(this.options.scope);this.searchOptions={layout:"results",scope:a(g).data("scope")},this._on(b,{change:function(a){a.preventDefault(),this.submit(this.form)}}),this._on(c,{change:function(b){b.preventDefault(),this.searchOptions.sort=a(b.currentTarget).val(),this.submit(a(b.currentTarget))}}),this._on(d,{change:function(b){b.preventDefault(),this.searchOptions.search_comments=a(b.currentTarget).is(":checked"),this.submit(a(b.currentTarget))}}),this._on(this.form,{SearchNearby:function(a){f.prop("disabled",!1),c.find('option[value="distance"]').prop("disabled",!1),c.val("distance"),this.searchOptions.range=f.val(),this.searchOptions.search_nearby=e.val(),this.searchOptions.sort="distance",this.submit(e)}}),this._on(e,{change:function(b){b.preventDefault(),""==a(b.currentTarget).val()&&(f.prop("disabled",!0),c.find('option[value="distance"]').prop("disabled",!0),c.val("relevant"),this.searchOptions.search_nearby=null,this.searchOptions.search_range=null,this.searchOptions.sort="relevant",this.submit(this.form))}}),this._on(f,{change:function(b){b.preventDefault(),this.searchOptions.search_range=f.val(),this.submit(a(b.currentTarget))}})},changeScope:function(b){this.searchOptions.scope=a(b).data("scope"),this.submit(a(b))},submit:function(b){var c=this;a.ajax({method:"get",url:this.form.attr("action")+"?"+this.form.serialize(),data:this.searchOptions,beforeSend:function(){b.fadeTo("fast",.3).addClass("uiActivityIndicator")},success:function(b,d,e){b=a(b),a(c.options.results).data("fetched-items",b.filter(".an-entity")),a(c.element).trigger("masonry-reset-render"),a(c.options.searchScopes).replaceWith(b.filter(c.options.searchScopes))},complete:function(){b.fadeTo("fast",1).removeClass("uiActivityIndicator");var d=c.form.attr("action")+"?"+c.form.serialize()+"&"+a.param(c.searchOptions);a(c.element).data("newUrl",d).trigger("urlChange")}})}});var d=a("#an-search-results").search();a("body").on("click",'[data-trigger="ChangeScope"]',function(a){a.preventDefault(),d.search("changeScope",this)})}(jQuery,window,document);